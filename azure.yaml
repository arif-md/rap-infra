name: raptor
infra:
  provider: bicep
  path: .
  deploymentStacks:
    # On azd down, delete managed resources but keep the resource group intact
    # Key Vault is NOT in deployment stack (created by preprovision script), so it won't be deleted
    actionOnUnmanage:
      resources: delete
      resourceGroups: detach
    denySettings:
      mode: none

hooks:
  preprovision:
    windows:
      shell: pwsh
      run: ./scripts/run-preprovision-hooks.ps1
      interactive: false
    posix:
      shell: sh
      run: ./scripts/run-preprovision-hooks.sh
      interactive: false

hooks:
  # Post-provision hook: Grants SQL permissions to backend managed identity
  # 
  # LOCAL DEVELOPMENT:
  #   - Runs automatically after 'azd provision' or 'azd up'
  #   - Uses 'az sql db query --auth-type ActiveDirectoryDefault' for simplicity
  #   - Requires: User must be member of RAP-SQL-Admins Azure AD group
  #   - Best effort: May fail if Azure AD tokens not cached or group membership not propagated
  # 
  # GITHUB ACTIONS (CI/CD):
  #   - Postprovision hook is SKIPPED (detects GITHUB_ACTIONS=true environment variable)
  #   - Uses separate 'grant-sql-permissions' workflow job instead (more robust)
  #   - That job uses Python + pyodbc with explicit Azure AD token for reliability
  #   - Handles firewall rules, container restarts, and cleanup automatically
  # 
  # Why the distinction?
  #   - Local: Interactive authentication, simpler tooling, developer convenience
  #   - CI/CD: Ephemeral runners, explicit token auth, guaranteed cleanup, automated restart
  postprovision:
    windows:
      shell: pwsh
      run: ./scripts/postprovision.ps1
      interactive: false
    posix:
      shell: sh
      run: ./scripts/postprovision.sh
      interactive: false
