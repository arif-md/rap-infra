name: Provision Infrastructure

on:
  workflow_dispatch:
    inputs:
      targetEnv:
        description: "GitHub Environment name to run under (e.g., dev/test/train/prod)"
        required: false
        default: "dev"
  push:
    branches: [ main ]
    paths:
      - 'main.bicep'
      - 'main.parameters.json'
      - 'modules/**'
      - 'shared/**'
      - '!app/**'  # Exclude app-specific Bicep files

jobs:
  provision:
    runs-on: ubuntu-latest
    environment: ${{ inputs.targetEnv || vars.DEFAULT_GITHUB_ENV || 'dev' }}
    outputs:
      resource_group: ${{ env.AZURE_RESOURCE_GROUP }}
    concurrency:
      group: azure-deployment-${{ inputs.targetEnv || vars.DEFAULT_GITHUB_ENV || 'dev' }}
      cancel-in-progress: false
    env:
      # Use environment-scoped variables; define these per GitHub Environment (test/train/prod)
      AZURE_ENV_NAME: ${{ vars.AZURE_ENV_NAME || 'dev' }}
      AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
      AZURE_ACR_NAME: ${{ vars.AZURE_ACR_NAME }}
      AZURE_ACR_RESOURCE_GROUP: ${{ vars.AZURE_ACR_RESOURCE_GROUP }}
      KEY_VAULT_NAME: ${{ vars.KEY_VAULT_NAME || '' }}
    permissions:
      id-token: write   # for OIDC
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Azure Developer CLI (preferred)
        uses: Azure/setup-azd@v2
        with:
          version: latest
        continue-on-error: true

      - name: Ensure azd installed (fallback)
        run: |
          if ! command -v azd >/dev/null 2>&1; then
            echo "setup-azd failed; installing via script"
            curl -fsSL https://aka.ms/install-azd.sh | bash
            echo "$HOME/.azure-dev/bin" >> $GITHUB_PATH
          fi
          azd version

      - name: azd auth login (OIDC via provider)
        run: |
          echo "Authenticating azd using GitHub OIDC provider"
          azd auth login \
            --client-id "${{ secrets.AZURE_CLIENT_ID }}" \
            --tenant-id "${{ secrets.AZURE_TENANT_ID }}" \
            --federated-credential-provider github

      - name: Verify az/azd auth
        shell: bash
        run: |
          set -euo pipefail
          az account show -o none
          az account get-access-token -o none
          command -v azd >/dev/null 2>&1
          azd version

      - name: "Sanity: environment variables (resolved)"
        shell: bash
        run: |
          echo "Using GitHub Environment: ${{ job.environment.name }}"
          echo "AZURE_ENV_NAME=$AZURE_ENV_NAME"
          echo "AZURE_RESOURCE_GROUP=$AZURE_RESOURCE_GROUP"
          echo "AZURE_ACR_NAME=$AZURE_ACR_NAME"
          echo "AZURE_ACR_RESOURCE_GROUP=$AZURE_ACR_RESOURCE_GROUP"

      - name: Enable azd alpha features (deployment stacks)
        run: azd config set alpha.deployment.stacks on

      - name: Ensure AZURE_ENV_NAME default
        run: |
          if [ -z "$AZURE_ENV_NAME" ]; then
            NAME="${GITHUB_REF_NAME:-dev}"
            SAFE=$(echo "$NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g')
            echo "AZURE_ENV_NAME=$SAFE" >> $GITHUB_ENV
            echo "Using fallback AZURE_ENV_NAME: $SAFE"
          else
            echo "Using provided AZURE_ENV_NAME: $AZURE_ENV_NAME"
          fi

      - name: Prepare azd environment
        run: |
          azd env new $AZURE_ENV_NAME --no-prompt || true
          azd env set AZURE_ENV_NAME "$AZURE_ENV_NAME"
          azd env set AZURE_RESOURCE_GROUP "$AZURE_RESOURCE_GROUP"
          if [ -n "$AZURE_ACR_RESOURCE_GROUP" ]; then
            azd env set AZURE_ACR_RESOURCE_GROUP "$AZURE_ACR_RESOURCE_GROUP"
          fi
          RG_LOC=$(az group show -n "$AZURE_RESOURCE_GROUP" --query location -o tsv 2>/dev/null || true)
          if [ -n "$RG_LOC" ]; then
            echo "Resolved location from RG '$AZURE_RESOURCE_GROUP': $RG_LOC"
          else
            echo "Warning: Could not resolve location for RG '$AZURE_RESOURCE_GROUP'"
          fi
          azd env set AZURE_ACR_NAME "$AZURE_ACR_NAME"
          azd env set AZURE_SUBSCRIPTION_ID "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
          
          # Set Key Vault name if provided (optional - preprovision script will calculate if not set)
          if [ -n "$KEY_VAULT_NAME" ]; then
            azd env set KEY_VAULT_NAME "$KEY_VAULT_NAME"
            echo "Using provided KEY_VAULT_NAME: $KEY_VAULT_NAME"
          else
            echo "KEY_VAULT_NAME not set - preprovision script will calculate it"
          fi
          
          # Set SQL Admin Password - Required for SQL Server resource in main.bicep
          # This is a @secure() Bicep parameter that requires a value in non-interactive mode (--no-prompt).
          # Used only for SQL Server admin account; backend application uses passwordless managed identity.
          if [ -n "${{ secrets.SQL_ADMIN_PASSWORD || '' }}" ]; then
            azd env set SQL_ADMIN_PASSWORD "${{ secrets.SQL_ADMIN_PASSWORD }}"
          elif [ -n "${{ vars.SQL_ADMIN_PASSWORD || '' }}" ]; then
            azd env set SQL_ADMIN_PASSWORD "${{ vars.SQL_ADMIN_PASSWORD }}"
          else
            echo "WARNING: SQL_ADMIN_PASSWORD not set. Deployment may fail if SQL resources need to be updated."
          fi
          
          echo "DEBUG: SQL_AZURE_AD_ADMIN_OBJECT_ID : ${{ vars.SQL_AZURE_AD_ADMIN_OBJECT_ID || '' }}"
          echo "DEBUG: SQL_AZURE_AD_ADMIN_LOGIN : ${{ vars.SQL_AZURE_AD_ADMIN_LOGIN || '' }}"
          
          # Set SQL Azure AD Admin - Required for passwordless authentication and managed identity permissions
          if [ -n "${{ vars.SQL_AZURE_AD_ADMIN_OBJECT_ID || '' }}" ]; then
            azd env set SQL_AZURE_AD_ADMIN_OBJECT_ID "${{ vars.SQL_AZURE_AD_ADMIN_OBJECT_ID }}"
          else
            echo "WARNING: SQL_AZURE_AD_ADMIN_OBJECT_ID not set. Using service principal from AZURE_CLIENT_ID."
            azd env set SQL_AZURE_AD_ADMIN_OBJECT_ID "${{ secrets.AZURE_CLIENT_ID }}"
          fi
          
          if [ -n "${{ vars.SQL_AZURE_AD_ADMIN_LOGIN || '' }}" ]; then
            azd env set SQL_AZURE_AD_ADMIN_LOGIN "${{ vars.SQL_AZURE_AD_ADMIN_LOGIN }}"
          else
            echo "WARNING: SQL_AZURE_AD_ADMIN_LOGIN not set. Using default: sp-raptordev"
            azd env set SQL_AZURE_AD_ADMIN_LOGIN "sp-raptordev"
          fi
          
          # Set principal type - "Application" for service principals, "User" for user accounts
          if [ -n "${{ vars.SQL_AZURE_AD_ADMIN_PRINCIPAL_TYPE || '' }}" ]; then
            azd env set SQL_AZURE_AD_ADMIN_PRINCIPAL_TYPE "${{ vars.SQL_AZURE_AD_ADMIN_PRINCIPAL_TYPE }}"
          else
            echo "Using default principal type: Application (service principal)"
            azd env set SQL_AZURE_AD_ADMIN_PRINCIPAL_TYPE "Application"
          fi

      - name: Ensure ACR exists (preprovision)
        shell: bash
        run: |
          set -euo pipefail
          chmod +x scripts/ensure-acr.sh
          ./scripts/ensure-acr.sh

      - name: Resolve images (preprovision)
        shell: bash
        run: |
          set -euo pipefail
          chmod +x scripts/resolve-images.sh
          ./scripts/resolve-images.sh

      - name: Validate image vs ACR binding (guard)
        shell: bash
        run: |
          set -euo pipefail
          chmod +x scripts/validate-acr-binding.sh
          ./scripts/validate-acr-binding.sh

      - name: Provision infrastructure (azd provision)
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üèóÔ∏è  Provisioning shared infrastructure and all services"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "This workflow provisions:"
          echo "  - Azure Container Registry (if not exists)"
          echo "  - Container Apps Environment"
          echo "  - Log Analytics Workspace"
          echo "  - Application Insights"
          echo "  - Frontend Container App (dev-rap-fe)"
          echo "  - Backend Container App (dev-rap-be)"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          azd provision --no-prompt --environment "$AZURE_ENV_NAME"

      - name: Extract SQL permission script
        if: success()
        shell: bash
        run: |
          echo "Extracting SQL permission script from deployment outputs..."
          
          # Try to get from deployment stack first (alpha feature)
          STACK_NAME="azd-stack-$AZURE_ENV_NAME"
          SQL_SCRIPT=$(az stack group show \
            --name "$STACK_NAME" \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --query "outputs.sqlPermissionScript.value" -o tsv 2>/dev/null || echo "")
          
          # Fallback to regular deployment if stack query fails
          if [ -z "$SQL_SCRIPT" ] || [ "$SQL_SCRIPT" = "null" ]; then
            echo "Stack query failed or returned null, trying regular deployment..."
            DEPLOYMENT=$(az deployment group list \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --query "[0].name" -o tsv)
            
            SQL_SCRIPT=$(az deployment group show \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --name "$DEPLOYMENT" \
              --query "properties.outputs.sqlPermissionScript.value" -o tsv 2>/dev/null || echo "")
          fi
          
          if [ -n "$SQL_SCRIPT" ] && [ "$SQL_SCRIPT" != "null" ] && [ "$SQL_SCRIPT" != "" ]; then
            echo "‚úÖ SQL permission script extracted successfully"
            echo "SQL_PERMISSION_SCRIPT<<EOF" >> $GITHUB_ENV
            echo "$SQL_SCRIPT" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            echo "HAS_SQL_SCRIPT=true" >> $GITHUB_ENV
          else
            echo "‚ö†Ô∏è No SQL permission script found in deployment outputs"
            echo "HAS_SQL_SCRIPT=false" >> $GITHUB_ENV
          fi

      - name: Show deployment summary
        if: success()
        shell: bash
        run: |
          echo "‚úÖ Infrastructure provisioning completed successfully!"
          echo ""
          echo "üìä Deployed Resources:"
          
          # Get Container Apps
          APPS=$(az containerapp list -g "$AZURE_RESOURCE_GROUP" --query "[].{Name:name,Status:properties.provisioningState,Fqdn:properties.configuration.ingress.fqdn}" -o tsv 2>/dev/null || true)
          
          if [ -n "$APPS" ]; then
            echo ""
            echo "Container Apps:"
            echo "$APPS" | while IFS=$'\t' read -r name status fqdn; do
              echo "  - $name"
              echo "    Status: $status"
              if [ -n "$fqdn" ] && [ "$fqdn" != "null" ]; then
                echo "    URL: https://$fqdn"
              fi
            done
          fi
          
          # Get ACR
          ACR_INFO=$(az acr show -n "$AZURE_ACR_NAME" -g "${AZURE_ACR_RESOURCE_GROUP:-$AZURE_RESOURCE_GROUP}" --query "{Name:name,LoginServer:loginServer,Sku:sku.name}" -o tsv 2>/dev/null || true)
          if [ -n "$ACR_INFO" ]; then
            echo ""
            echo "Container Registry:"
            echo "$ACR_INFO" | while IFS=$'\t' read -r name login sku; do
              echo "  - $name ($sku)"
              echo "    Login Server: $login"
            done
          fi
          
          {
            echo "### üèóÔ∏è Infrastructure Provisioning Complete"
            echo ""
            echo "**Environment**: $AZURE_ENV_NAME"
            echo "**Resource Group**: $AZURE_RESOURCE_GROUP"
            echo ""
            if [ -n "$APPS" ]; then
              echo "**Container Apps**:"
              echo "$APPS" | while IFS=$'\t' read -r name status fqdn; do
                echo "- **$name**: $status"
                if [ -n "$fqdn" ] && [ "$fqdn" != "null" ]; then
                  echo "  - URL: https://$fqdn"
                fi
              done
            fi
            
            # Add SQL permission script if available
            if [ "$HAS_SQL_SCRIPT" = "true" ]; then
              echo ""
              echo "---"
              echo ""
              echo "### üîê SQL Permissions Setup Required"
              echo ""
              echo "**‚ö†Ô∏è MANUAL ACTION NEEDED**: Execute the following SQL script to grant database permissions to the backend managed identity."
              echo ""
              echo "**Instructions**:"
              echo "1. Go to [Azure Portal](https://portal.azure.com)"
              echo "2. Navigate to SQL Database: \`$AZURE_RESOURCE_GROUP\` resource group"
              echo "3. Click on the SQL Database"
              echo "4. Click **Query editor** in the left menu"
              echo "5. Sign in with **Azure AD** (use the SQL Server Azure AD admin account)"
              echo "6. Copy and paste the script below"
              echo "7. Click **Run**"
              echo ""
              echo "<details>"
              echo "<summary>üìã Click to expand SQL Permission Script</summary>"
              echo ""
              echo "\`\`\`sql"
              echo "$SQL_PERMISSION_SCRIPT"
              echo "\`\`\`"
              echo ""
              echo "</details>"
              echo ""
              echo "After executing the script, restart the backend container app:"
              echo "\`\`\`bash"
              echo "az containerapp revision restart --name <backend-app-name> --resource-group $AZURE_RESOURCE_GROUP"
              echo "\`\`\`"
            fi
          } >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Infrastructure provisioning failed!"
          echo "Check the logs above for error details."
          echo ""
          echo "Common issues:"
          echo "  - Deployment stack in non-terminal state (another deployment running)"
          echo "  - Invalid Bicep configuration"
          echo "  - Missing permissions"
          echo "  - Resource quota limits"

  # SQL permissions are now granted manually via Azure Portal
  # See the "SQL Database Permissions" section in the provision job summary above
  # for the generated SQL script and step-by-step instructions
  #
  # grant-sql-permissions:
  #   needs: provision
  #   uses: ./.github/workflows/grant-sql-permissions.yml
  #   with:
  #     environment: ${{ inputs.targetEnv || 'dev' }}
  #     resource_group: ${{ needs.provision.outputs.resource_group }}
  #   secrets: inherit
