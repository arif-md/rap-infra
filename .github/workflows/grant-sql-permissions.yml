name: Grant SQL Permissions to Managed Identity

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment name (dev, staging, prod)'
        required: true
        default: 'dev'
      resource_group:
        description: 'Azure resource group name (optional, will auto-discover if not provided)'
        required: false
  workflow_call:
    inputs:
      environment:
        description: 'Environment name'
        required: true
        type: string
      resource_group:
        description: 'Azure resource group name'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  grant-permissions:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Azure environment variables
        id: get-env
        run: |
          # Use provided resource group or auto-discover
          if [ -n "${{ inputs.resource_group }}" ]; then
            RESOURCE_GROUP="${{ inputs.resource_group }}"
            echo "Using provided resource group: $RESOURCE_GROUP"
          else
            RESOURCE_GROUP=$(az group list --query "[?contains(name, 'rg-raptor-${{ inputs.environment }}')].name" -o tsv | head -n 1)
            if [ -z "$RESOURCE_GROUP" ]; then
              echo "❌ Resource group not found for environment ${{ inputs.environment }}"
              exit 1
            fi
            echo "Auto-discovered resource group: $RESOURCE_GROUP"
          fi
          echo "resource_group=$RESOURCE_GROUP" >> $GITHUB_OUTPUT
          
          SQL_SERVER=$(az sql server list -g $RESOURCE_GROUP --query "[0].name" -o tsv)
          if [ -z "$SQL_SERVER" ]; then
            echo "❌ SQL Server not found in resource group $RESOURCE_GROUP"
            exit 1
          fi
          echo "sql_server=$SQL_SERVER" >> $GITHUB_OUTPUT
          
          SQL_DATABASE=$(az sql db list -g $RESOURCE_GROUP -s $SQL_SERVER --query "[?name != 'master'].name | [0]" -o tsv)
          if [ -z "$SQL_DATABASE" ]; then
            echo "❌ SQL Database not found"
            exit 1
          fi
          echo "sql_database=$SQL_DATABASE" >> $GITHUB_OUTPUT
          
          BACKEND_IDENTITY=$(az identity list -g $RESOURCE_GROUP --query "[?contains(name, 'backend')].name | [0]" -o tsv)
          if [ -z "$BACKEND_IDENTITY" ]; then
            echo "❌ Backend managed identity not found"
            exit 1
          fi
          echo "backend_identity=$BACKEND_IDENTITY" >> $GITHUB_OUTPUT
          
          echo "✅ Found resources:"
          echo "  Resource Group: $RESOURCE_GROUP"
          echo "  SQL Server: $SQL_SERVER"
          echo "  SQL Database: $SQL_DATABASE"
          echo "  Backend Identity: $BACKEND_IDENTITY"

      - name: Install sqlcmd
        run: |
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo tee /etc/apt/trusted.gpg.d/microsoft.asc
          curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y mssql-tools18 unixodbc-dev
          echo "/opt/mssql-tools18/bin" >> $GITHUB_PATH

      - name: Add temporary firewall rule
        id: firewall
        run: |
          MY_IP=$(curl -s https://api.ipify.org)
          echo "Current IP: $MY_IP"
          
          az sql server firewall-rule create \
            -g ${{ steps.get-env.outputs.resource_group }} \
            -s ${{ steps.get-env.outputs.sql_server }} \
            -n "GitHubActions-$(date +%s)" \
            --start-ip-address $MY_IP \
            --end-ip-address $MY_IP
          
          echo "firewall_rule=GitHubActions-$(date +%s)" >> $GITHUB_OUTPUT

      - name: Grant SQL permissions
        env:
          SQL_SERVER: ${{ steps.get-env.outputs.sql_server }}
          SQL_DATABASE: ${{ steps.get-env.outputs.sql_database }}
          BACKEND_IDENTITY: ${{ steps.get-env.outputs.backend_identity }}
          SQL_ADMIN_PASSWORD: ${{ secrets.SQL_ADMIN_PASSWORD }}
        run: |
          SQL_SERVER_FQDN="${SQL_SERVER}.database.windows.net"
          
          echo "Granting permissions to managed identity: $BACKEND_IDENTITY"
          
          # Get Azure AD access token
          ACCESS_TOKEN=$(az account get-access-token --resource https://database.windows.net --query accessToken -o tsv)
          
          # Create SQL script
          SQL_SCRIPT="
          IF NOT EXISTS (SELECT * FROM sys.database_principals WHERE name = '$BACKEND_IDENTITY')
          BEGIN
              PRINT 'Creating user from external provider...'
              CREATE USER [$BACKEND_IDENTITY] FROM EXTERNAL PROVIDER
          END
          ELSE
          BEGIN
              PRINT 'User already exists.'
          END
          
          IF IS_ROLEMEMBER('db_datareader', '$BACKEND_IDENTITY') = 0
          BEGIN
              PRINT 'Granting db_datareader role...'
              ALTER ROLE db_datareader ADD MEMBER [$BACKEND_IDENTITY]
          END
          
          IF IS_ROLEMEMBER('db_datawriter', '$BACKEND_IDENTITY') = 0
          BEGIN
              PRINT 'Granting db_datawriter role...'
              ALTER ROLE db_datawriter ADD MEMBER [$BACKEND_IDENTITY]
          END
          
          IF IS_ROLEMEMBER('db_ddladmin', '$BACKEND_IDENTITY') = 0
          BEGIN
              PRINT 'Granting db_ddladmin role (for Flyway migrations)...'
              ALTER ROLE db_ddladmin ADD MEMBER [$BACKEND_IDENTITY]
          END
          
          PRINT 'Permissions granted successfully.'
          "
          
          # Execute SQL using Azure AD authentication
          /opt/mssql-tools18/bin/sqlcmd -S $SQL_SERVER_FQDN -d $SQL_DATABASE \
            -G -P "$ACCESS_TOKEN" -C \
            -Q "$SQL_SCRIPT"
          
          echo "✅ SQL permissions granted successfully!"

      - name: Remove firewall rule
        if: always() && steps.firewall.outputs.firewall_rule
        run: |
          az sql server firewall-rule delete \
            -g ${{ steps.get-env.outputs.resource_group }} \
            -s ${{ steps.get-env.outputs.sql_server }} \
            -n "${{ steps.firewall_rule }}" || true
